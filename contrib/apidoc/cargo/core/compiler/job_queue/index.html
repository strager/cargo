<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="This module implements the job queue which determines the ordering in which rustc is spawned off. It also manages the allocation of jobserver tokens to rustc beyond the implicit token each rustc owns (i.e., the ones used for parallel LLVM work and parallel rustc threads)."><meta name="keywords" content="rust, rustlang, rust-lang, job_queue"><title>cargo::core::compiler::job_queue - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../SourceSerif4-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../FiraSans-Regular.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../FiraSans-Medium.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../SourceCodePro-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../SourceSerif4-Bold.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../SourceCodePro-Semibold.ttf.woff2"><link rel="stylesheet" href="../../../../normalize.css"><link rel="stylesheet" href="../../../../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" href="../../../../ayu.css" disabled><link rel="stylesheet" href="../../../../dark.css" disabled><link rel="stylesheet" href="../../../../light.css" id="themeStyle"><script id="default-settings" ></script><script src="../../../../storage.js"></script><script defer src="../../../../main.js"></script><noscript><link rel="stylesheet" href="../../../../noscript.css"></noscript><link rel="alternate icon" type="image/png" href="../../../../favicon-16x16.png"><link rel="alternate icon" type="image/png" href="../../../../favicon-32x32.png"><link rel="icon" type="image/svg+xml" href="../../../../favicon.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="sidebar-logo" href="../../../../cargo/index.html"><div class="logo-container"><img class="rust-logo" src="../../../../rust-logo.svg" alt="logo"></div></a><h2></h2></nav><nav class="sidebar"><a class="sidebar-logo" href="../../../../cargo/index.html"><div class="logo-container"><img class="rust-logo" src="../../../../rust-logo.svg" alt="logo"></div></a><h2 class="location"><a href="#">Module job_queue</a></h2><div class="sidebar-elems"><section><ul class="block"><li><a href="#structs">Structs</a></li><li><a href="#enums">Enums</a></li></ul></section></div></nav><main><div class="width-limiter"><nav class="sub"><form class="search-form"><span></span><input class="search-input" name="search" autocomplete="off" spellcheck="false" placeholder="Click or press â€˜Sâ€™ to search, â€˜?â€™ for more optionsâ€¦" type="search"><div id="help-button" title="help" tabindex="-1"><a href="../../../../help.html">?</a></div><div id="settings-menu" tabindex="-1"><a href="../../../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../../../wheel.svg"></a></div></form></nav><section id="main-content" class="content"><div class="main-heading"><h1 class="fqn">Module <a href="../../../index.html">cargo</a>::<wbr><a href="../../index.html">core</a>::<wbr><a href="../index.html">compiler</a>::<wbr><a class="mod" href="#">job_queue</a><button id="copy-path" onclick="copy_path(this)" title="Copy item path to clipboard"><img src="../../../../clipboard.svg" width="19" height="18" alt="Copy item path"></button></h1><span class="out-of-band"><a class="srclink" href="../../../../src/cargo/core/compiler/job_queue.rs.html#1-1439">source</a> Â· <a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">[<span class="inner">&#x2212;</span>]</a></span></div><details class="rustdoc-toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>This module implements the job queue which determines the ordering in which
rustc is spawned off. It also manages the allocation of jobserver tokens to
rustc beyond the implicit token each rustc owns (i.e., the ones used for
parallel LLVM work and parallel rustc threads).</p>
<p>Cargo and rustc have a somewhat non-trivial jobserver relationship with each
other, which is due to scaling issues with sharing a single jobserver
amongst what is potentially hundreds of threads of work on many-cored
systems on (at least) linux, and likely other platforms as well.</p>
<p>The details of this algorithm are (also) written out in
src/librustc_jobserver/lib.rs. What follows is a description focusing on the
Cargo side of things.</p>
<p>Cargo wants to complete the build as quickly as possible, fully saturating
all cores (as constrained by the -j=N) parameter. Cargo also must not spawn
more than N threads of work: the total amount of tokens we have floating
around must always be limited to N.</p>
<p>It is not really possible to optimally choose which crate should build first
or last; nor is it possible to decide whether to give an additional token to
rustc first or rather spawn a new crate of work. For now, the algorithm we
implement prioritizes spawning as many crates (i.e., rustc processes) as
possible, and then filling each rustc with tokens on demand.</p>
<p>The primary loop is in <code>drain_the_queue</code> below.</p>
<p>We integrate with the jobserver, originating from GNU make, to make sure
that build scripts which use make to build C code can cooperate with us on
the number of used tokens and avoid overfilling the system weâ€™re on.</p>
<p>The jobserver is unfortunately a very simple protocol, so we enhance it a
little when we know that there is a rustc on the other end. Via the stderr
pipe we have to rustc, we get messages such as â€œNeedsTokenâ€ and
â€œReleaseTokenâ€ from rustc.</p>
<p>â€œNeedsTokenâ€ indicates that a rustc is interested in acquiring a token, but
never that it would be impossible to make progress without one (i.e., it
would be incorrect for rustc to not terminate due to an unfulfilled
NeedsToken request); we do not usually fulfill all NeedsToken requests for a
given rustc.</p>
<p>â€œReleaseTokenâ€ indicates that a rustc is done with one of its tokens and is
ready for us to re-acquire ownership â€“ we will either release that token
back into the general pool or reuse it ourselves. Note that rustc will
inform us that it is releasing a token even if it itself is also requesting
tokens; is is up to us whether to return the token to that same rustc.</p>
<p>The current scheduling algorithm is relatively primitive and could likely be
improved.</p>
</div></details><h2 id="structs" class="small-section-header"><a href="#structs">Structs</a></h2><div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.DiagDedupe.html" title="cargo::core::compiler::job_queue::DiagDedupe struct">DiagDedupe</a><span title="Restricted Visibility">&nbsp;ğŸ”’</span> </div><div class="item-right docblock-short">Handler for deduplicating diagnostics.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.DrainState.html" title="cargo::core::compiler::job_queue::DrainState struct">DrainState</a><span title="Restricted Visibility">&nbsp;ğŸ”’</span> </div><div class="item-right docblock-short">This structure is backed by the <code>DependencyQueue</code> type and manages the
actual compilation step of each package. Packages enqueue units of work and
then later on the entire graph is processed and compiled.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.ErrorToHandle.html" title="cargo::core::compiler::job_queue::ErrorToHandle struct">ErrorToHandle</a><span title="Restricted Visibility">&nbsp;ğŸ”’</span> </div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.ErrorsDuringDrain.html" title="cargo::core::compiler::job_queue::ErrorsDuringDrain struct">ErrorsDuringDrain</a></div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.JobId.html" title="cargo::core::compiler::job_queue::JobId struct">JobId</a></div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.JobQueue.html" title="cargo::core::compiler::job_queue::JobQueue struct">JobQueue</a></div><div class="item-right docblock-short">This structure is backed by the <code>DependencyQueue</code> type and manages the
queueing of compilation steps for each package. Packages enqueue units of
work and then later on the entire graph is converted to DrainState and
executed.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.JobState.html" title="cargo::core::compiler::job_queue::JobState struct">JobState</a></div><div class="item-right docblock-short">A <code>JobState</code> is constructed by <code>JobQueue::run</code> and passed to <code>Job::run</code>. It includes everything
necessary to communicate between the main thread and the execution of the job.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.WarningCount.html" title="cargo::core::compiler::job_queue::WarningCount struct">WarningCount</a></div><div class="item-right docblock-short">Count of warnings, used to print a summary after the job succeeds</div></div></div><h2 id="enums" class="small-section-header"><a href="#enums">Enums</a></h2><div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="enum" href="enum.Artifact.html" title="cargo::core::compiler::job_queue::Artifact enum">Artifact</a><span title="Restricted Visibility">&nbsp;ğŸ”’</span> </div><div class="item-right docblock-short">Possible artifacts that can be produced by compilations, used as edge values
in the dependency graph.</div></div><div class="item-row"><div class="item-left module-item"><a class="enum" href="enum.FixableWarnings.html" title="cargo::core::compiler::job_queue::FixableWarnings enum">FixableWarnings</a></div><div class="item-right docblock-short">Used to keep track of how many fixable warnings there are
and if fixable warnings are allowed</div></div><div class="item-row"><div class="item-left module-item"><a class="enum" href="enum.Message.html" title="cargo::core::compiler::job_queue::Message enum">Message</a><span title="Restricted Visibility">&nbsp;ğŸ”’</span> </div></div></div></section></div></main><div id="rustdoc-vars" data-root-path="../../../../" data-current-crate="cargo" data-themes="ayu,dark,light" data-resource-suffix="" data-rustdoc-version="1.66.0 (69f9c33d7 2022-12-12)" ></div></body></html>